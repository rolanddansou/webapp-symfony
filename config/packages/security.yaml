security:
    # https://symfony.com/doc/current/security.html#registering-the-user-hashing-passwords
    password_hashers:
        Symfony\Component\Security\Core\User\PasswordAuthenticatedUserInterface: 'auto'
        App\Entity\Access\Identity:
            algorithm: auto

    # https://symfony.com/doc/current/security.html#loading-the-user-the-user-provider
    providers:
        # Provider pour l'authentification via Identity (email + credentials)
        app_user_provider:
            id: App\Feature\Access\Security\IdentityProvider

        # Provider spécifique pour l'administration (uniquement utilisateurs AdminUser)
        admin_user_provider:
            id: App\Feature\Access\Security\AdminProvider

    # Hiérarchie des rôles
    role_hierarchy:
        ROLE_ADMIN: ROLE_BACKEND
        ROLE_BACKEND: ROLE_USER
        ROLE_SUPER_ADMIN: [ROLE_ADMIN, ROLE_ALLOWED_TO_SWITCH]

    firewalls:
        dev:
            pattern: ^/(_profiler|_wdt|assets|build)/
            security: false

        # API REST - Routes publiques
        api_public:
            pattern: ^/api/(auth/(register|login|refresh|forgot-password|reset-password|verify-email|verify-reset-code|resend-verification|verification/(verify|send))|offers/active|docs)
            stateless: true
            security: false

        # API REST - Routes authentifiées (partage le contexte avec main)
        api:
            pattern: ^/api
            stateless: false
            provider: app_user_provider
            context: shared_context
            # JWT désactivé car on utilise les sessions partagées avec main
            # Si vous avez besoin de JWT pour des clients externes, réactivez-le
            # jwt: ~
            # entry_point: jwt

        # Interface d'administration (session + remember_me)
        admin:
            pattern: ^/admin
            stateless: false
            provider: admin_user_provider
            lazy: true
            context: admin_context

            # Formulaire de connexion admin
            form_login:
                login_path: admin_login
                check_path: admin_login
                default_target_path: admin
                enable_csrf: true

            # Déconnexion
            logout:
                path: admin_logout
                target: admin_login
            login_throttling: true
            user_checker: App\Feature\Access\Service\AdminIdentityChecker

            # Remember me (cookie 30 jours)
            remember_me:
                secret: '%kernel.secret%'
                lifetime: 2592000 # 30 jours
                path: /admin
                always_remember_me: true

            # Switch user pour débogage (SUPER_ADMIN uniquement)
            switch_user: true

        # Routes publiques (partage le contexte avec api)
        main:
            lazy: true
            provider: app_user_provider
            stateless: false
            context: shared_context

            # Formulaire de connexion utilisateur
            form_login:
                login_path: login
                check_path: login
                default_target_path: /
                enable_csrf: true

            # Déconnexion
            logout:
                path: /logout
                target: /

            # Remember me optionnel pour l'interface utilisateur
            remember_me:
                secret: '%kernel.secret%'
                lifetime: 2592000 # 30 jours
                path: /
                always_remember_me: false


    # Access control
    access_control:
        # API - Authentification JWT requise
        #- { path: ^/api/auth/(register|login|refresh|forgot-password|reset-password|verify-email|verify-reset-code|resend-verification|verification/(verify|send)), roles: PUBLIC_ACCESS }
        #- { path: ^/api/docs, roles: PUBLIC_ACCESS }
        #- { path: ^/api, roles: IS_AUTHENTICATED_FULLY }
        #- { path: ^/api, roles: ROLE_USER }
        - { path: ^/api, roles: PUBLIC_ACCESS }

        # Admin - Rôles backend minimum
        - { path: ^/admin/login, roles: PUBLIC_ACCESS }
        - { path: ^/admin, roles: ROLE_BACKEND }

        # Routes publiques
        - { path: ^/, roles: PUBLIC_ACCESS }

when@test:
    security:
        password_hashers:
            # Password hashers are resource-intensive by design to ensure security.
            # In tests, it's safe to reduce their cost to improve performance.
            Symfony\Component\Security\Core\User\PasswordAuthenticatedUserInterface:
                algorithm: auto
                cost: 4 # Lowest possible value for bcrypt
                time_cost: 3 # Lowest possible value for argon
                memory_cost: 10 # Lowest possible value for argon
