parameters:
    app_name: '%env(APP_NAME)%'
    notification.from_email: '%env(NOTIFICATIONS_MAILER_SENDER_EMAIL)%'
    notification.from_name: '%env(NOTIFICATIONS_MAILER_SENDER_NAME)%'
    notification.dns: '%env(NOTIFICATIONS_MAILER_DSN)%'
    app.email_from: '%env(MAILER_FROM)%'
    app.support_email: '%env(SUPPORT_EMAIL)%'
    # Monitoring & Alerts
    monitoring.super_admin_email: '%env(SUPER_ADMIN_ALERT_EMAIL)%'
    monitoring.admin_email: '%env(ADMIN_ALERT_EMAIL)%'
    monitoring.enable_email_alerts: '%env(bool:ENABLE_ERROR_EMAIL_ALERTS)%'

services:
    # default configuration for services in *this* file
    _defaults:
        autowire: true      # Automatically injects dependencies in your services.
        autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.

    # makes classes in src/ available to be used as services
    # this creates a service per class whose id is the fully-qualified class name
    App\:
        resource: '../src/'
        exclude:
            - '../src/Feature/Access/Service/IdentityUser.php'
            - '../src/Feature/Notification/Channel/NotificationChannelInterface.php'
            - '../src/Entity/'
            - '../src/Kernel.php'

    App\EntityListener\:
        resource: '../src/EntityListener/'
        tags: [ 'doctrine.orm.entity_listener' ]

    # Alias par défaut pour UserProviderInterface (résout l'ambiguïté avec AdminProvider)
    Symfony\Component\Security\Core\User\UserProviderInterface:
        alias: App\Feature\Access\Security\IdentityProvider

    # Monitoring - ErrorMonitoringSubscriber avec loggers spécifiques
    App\EventSubscriber\ErrorMonitoringSubscriber:
        arguments:
            $logger: '@monolog.logger'
            $securityLogger: '@monolog.logger.security'
            $businessLogger: '@monolog.logger.business'
            $security: '@security.helper'
            $environment: '%kernel.environment%'

    App\EventSubscriber\PerformanceSubscriber:
        arguments:
            $performanceLogger: '@monolog.logger.performance'
            $managerRegistry: '@doctrine'
            $security: '@security.helper'
            $debug: '%kernel.debug%'

    # Provider Local avec Flysystem
    App\Feature\Media\Provider\FlysystemStorageProvider.local:
        class: App\Feature\Media\Provider\FlysystemStorageProvider
        arguments:
            $filesystem: '@local.storage'
            $name: 'local'
            $publicUrlBase: '/uploads'
        tags: [ 'file.storage.provider' ]

    # FileManager
    App\Feature\Media\Service\FileManager:
        arguments:
            $providers: !tagged_iterator file.storage.provider

    App\Feature\Media\Service\FileManagerInterface:
        alias: App\Feature\Media\Service\FileManager
        public: true

    # Auth Services
    App\Feature\Access\Service\AuthServiceInterface:
        alias: App\Feature\Access\Service\AuthService

    App\Feature\Access\Service\TokenServiceInterface:
        alias: App\Feature\Access\Service\TokenService

    # Mailer pour les alertes d'erreurs (séparé du mailer principal)
    error_mailer:
        class: Symfony\Component\Mailer\Mailer
        arguments:
            - '@error_mailer.transport'

    error_mailer.transport:
        class: Symfony\Component\Mailer\Transport\Smtp\EsmtpTransport
        factory: [ '@mailer.transport_factory', 'fromString' ]
        arguments:
            - '%env(MAILER_DSN_ERRORS)%'

    # Stratégie d'activation pour ne pas logger les 404
    monolog.activation_strategy.not_found_activation_strategy:
        class: Monolog\Handler\FingersCrossed\ErrorLevelActivationStrategy
        arguments:
            - !php/const Monolog\Level::Error

    # Notifications
    # SMS Providers - Configure one of these based on your provider
    # Twilio SMS Provider
    App\Feature\Notification\Channel\Sms\TwilioSmsProvider:
        arguments:
            $accountSid: '%env(default::TWILIO_ACCOUNT_SID)%'
            $authToken: '%env(default::TWILIO_AUTH_TOKEN)%'
            $fromNumber: '%env(default::TWILIO_PHONE_NUMBER)%'

    # Vonage SMS Provider (alternative)
    App\Feature\Notification\Channel\Sms\VonageSmsProvider:
        arguments:
            $apiKey: '%env(default::VONAGE_API_KEY)%'
            $apiSecret: '%env(default::VONAGE_API_SECRET)%'
            $senderId: '%env(default::VONAGE_SENDER_ID)%'

    # SMS Provider Interface - Default to Twilio (change to VonageSmsProvider if preferred)
    App\Feature\Notification\Channel\Sms\SmsProviderInterface:
        alias: App\Feature\Notification\Channel\Sms\TwilioSmsProvider

    # SMS Channel with provider injection
    App\Feature\Notification\Channel\SmsChannel:
        arguments:
            $smsProvider: '@App\Feature\Notification\Channel\Sms\SmsProviderInterface'
            $enabled: '%env(bool:SMS_CHANNEL_ENABLED)%'

    App\Feature\Notification\Channel\EmailChannel:
        arguments:
            $notificationsDsn: '%notification.dns%'
            $senderEmail: '%notification.from_email%'
            $senderName: '%notification.from_name%'
